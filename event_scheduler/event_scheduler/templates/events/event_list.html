{% extends 'base.html' %}

{% block title %}Events - Event Scheduler{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Events</h2>
    <a href="{% url 'event-create' %}" class="btn btn-primary">Create New Event</a>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Title</th>
                <th>Start</th>
                <th>End</th>
                <th>Recurrence</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="events-table-body">
            <!-- Events will be loaded here via JavaScript -->
        </tbody>
    </table>
</div>

<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center" id="pagination">
        <!-- Pagination will be added here via JavaScript -->
    </ul>
</nav>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // Load events
        function loadEvents(page = 1) {
            fetch(`/api/events/?page=${page}`)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('events-table-body');
                    tbody.innerHTML = '';
                    
                    data.results.forEach(event => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${event.title}</td>
                            <td>${new Date(event.start_time).toLocaleString()}</td>
                            <td>${new Date(event.end_time).toLocaleString()}</td>
                            <td>${event.recurrence_rule || 'None'}</td>
                            <td>
                                <a href="/events/${event.id}/" class="btn btn-sm btn-info">View</a>
                                <a href="/events/${event.id}/edit/" class="btn btn-sm btn-warning">Edit</a>
                                <button onclick="deleteEvent(${event.id})" class="btn btn-sm btn-danger">Delete</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });

                    // Update pagination
                    const pagination = document.getElementById('pagination');
                    pagination.innerHTML = '';
                    
                    if (data.previous) {
                        const prevLi = document.createElement('li');
                        prevLi.className = 'page-item';
                        prevLi.innerHTML = `<a class="page-link" href="#" onclick="loadEvents(${page - 1})">Previous</a>`;
                        pagination.appendChild(prevLi);
                    }

                    if (data.next) {
                        const nextLi = document.createElement('li');
                        nextLi.className = 'page-item';
                        nextLi.innerHTML = `<a class="page-link" href="#" onclick="loadEvents(${page + 1})">Next</a>`;
                        pagination.appendChild(nextLi);
                    }
                });
        }


        // Delete event
        window.deleteEvent = function(eventId) {
            if (confirm('Are you sure you want to delete this event?')) {
                fetch(`/api/events/${eventId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        loadEvents();
                        alert('Event deleted successfully');
                    } else {
                        alert('Error deleting event');
                    }
                });
            }
        };

        // Initial load
        loadEvents();
    });
</script>
{% endblock %}
